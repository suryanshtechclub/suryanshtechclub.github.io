<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Publisher</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <h2>ğŸ“± Camera Publisher</h2>
  <video id="localVideo" autoplay playsinline muted></video>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"></script>

  <script>
    // ğŸ”¹ Paste your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ğŸ”¹ Sign in anonymously
    firebase.auth().signInAnonymously();

    // ğŸ”¹ Get camera
    const video = document.getElementById("localVideo");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true })
      .then(stream => {
        video.srcObject = stream;
        startPublisher(stream);
      });

    async function startPublisher(stream) {
      const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      const callDoc = db.collection("calls").doc("live");
      const offerCandidates = callDoc.collection("offerCandidates");
      const answerCandidates = callDoc.collection("answerCandidates");

      pc.onicecandidate = e => e.candidate && offerCandidates.add(e.candidate.toJSON());

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await callDoc.set({ offer });

      callDoc.onSnapshot(snapshot => {
        const data = snapshot.data();
        if (data?.answer) pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      });

      answerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
        });
      });
    }
  </script>
</body>
</html>
