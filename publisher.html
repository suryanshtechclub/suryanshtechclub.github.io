<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Publisher - Live Cam + Recording</title>
</head>
<body>
  <h2>ðŸ“± Publisher (Phone Camera)</h2>
  <video id="localVideo" autoplay playsinline muted style="width:320px;"></video>
  <br>
  <button onclick="startRecording()">Start Recording</button>
  <button onclick="stopRecording()">Stop Recording</button>
  <a id="downloadLink" style="display:none;">Download Video</a>
  <canvas id="motionCanvas" width="320" height="240" style="display:none;"></canvas>

  <script>
    const video = document.getElementById("localVideo");
    let mediaRecorder, recordedChunks = [];

    // Access camera
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        video.srcObject = stream;
        startMotionDetection(stream);
      })
      .catch(err => alert("Camera access denied"));

    // ================= Recording =================
    function startRecording() {
      const stream = video.srcObject;
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedChunks = [];
        const url = URL.createObjectURL(blob);
        const a = document.getElementById("downloadLink");
        a.href = url;
        a.download = `recording_${Date.now()}.webm`;
        a.style.display = "inline";
        a.textContent = "Download Video";
      };
      mediaRecorder.start();
      console.log("Recording started");
    }

    function stopRecording() {
      if(mediaRecorder) mediaRecorder.stop();
      console.log("Recording stopped");
    }

    // ================= Motion Detection =================
    function startMotionDetection(stream){
      const canvas = document.getElementById("motionCanvas");
      const ctx = canvas.getContext("2d");
      let lastFrame = null;

      setInterval(() => {
        if(video.readyState < 2) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

        if(lastFrame){
          let diff = 0;
          for(let i=0;i<frame.data.length;i+=4){
            diff += Math.abs(frame.data[i]-lastFrame.data[i]);
          }
          if(diff>500000){ // motion threshold
            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `snapshot_${Date.now()}.png`;
              a.click();
              console.log("Motion detected â†’ snapshot saved");
            });
          }
        }
        lastFrame = frame;
      }, 1000); // every second
    }
  </script>
</body>
</html>
